<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\arg-parser\ArgParser\ArgParser.Core\DefaultParseStrategy.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using ArgParser.Core.Validation;

namespace ArgParser.Core
{
    public class DefaultParseStrategy&lt;T&gt; : DefaultParseStrategy, IParseStrategy&lt;T&gt;
    {
        /// &lt;inheritdoc /&gt;
        // ReSharper disable once SuspiciousTypeConversion.Global
        public DefaultParseStrategy(IEnumerable&lt;Func&lt;T&gt;&gt; factoryFuncs = null) : base(factoryFuncs?.Cast&lt;Func&lt;object&gt;&gt;())
        {

        }

        /// &lt;inheritdoc /&gt;
        public IParseResult Parse(IEnumerable&lt;IParser&lt;T&gt;&gt; parsers, string[] args)
        {
            return base.Parse(parsers, args);
        }
    }

    public class DefaultParseStrategy : IParseStrategy
    {
        /// &lt;inheritdoc /&gt;
        public DefaultParseStrategy(IEnumerable&lt;Func&lt;object&gt;&gt; factoryFuncs = null)
        {
            foreach (var factoryFunc in factoryFuncs ?? new Func&lt;object&gt;[0]) FactoryFunctions.Add(factoryFunc);
        }

        /// &lt;inheritdoc /&gt;
        public virtual IParseResult Parse(IEnumerable&lt;IParser&gt; parsers, string[] args)
        {
            var results = ParseInstances(parsers, args);
            return CreateParseResult(results);
        }

        protected virtual IParseResult CreateParseResult(List&lt;object&gt; results)
        {
            return new DefaultParseResult(results);
        }

        protected virtual List&lt;object&gt; ParseInstances(IEnumerable&lt;IParser&gt; parsers, string[] args)
        {
            var results = new List&lt;object&gt;();
            var list = parsers.ToList();
            foreach (var factoryFunction in FactoryFunctions)
            foreach (var parser in list)
            {
                var info = IterationInfoFactory.Create(args);
                var instance = factoryFunction();
                if (results.Any(r =&gt; r.GetType() == instance.GetType()))
                    continue;
                var hasFailed = false;
                var last = 0;
                while (!hasFailed &amp;&amp; !info.IsComplete &amp;&amp; parser.CanConsume(instance, info))
                {
                    info = parser.Consume(instance, info);
                    if (info.Index &lt;= last) hasFailed = true;
                }

                var validationResults =
                    Validators.Where(v =&gt; v.CanValidate(instance)).Select(v =&gt; v.Validate(instance));
                var passedValidation = validationResults.All(r =&gt; r.IsSuccess);
                if (!hasFailed &amp;&amp; info.IsComplete &amp;&amp; passedValidation) results.Add(instance);
            }

            return results;
        }

        public IList&lt;Func&lt;object&gt;&gt; FactoryFunctions { get; set; } = new List&lt;Func&lt;object&gt;&gt;();
        public virtual IIterationInfoFactory IterationInfoFactory { get; set; } = new DefaultIterationInfoFactory();
        public virtual IList&lt;IValidator&gt; Validators { get; set; } = new List&lt;IValidator&gt;();
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,81,12,121,1],[13,9,13,10,1],[15,9,15,10,1],[19,9,19,10,1],[20,13,20,46,1],[21,9,21,10,1],[27,9,27,83,1],[28,9,28,10,1],[29,13,29,20,1],[29,22,29,37,1],[29,38,29,40,1],[29,41,29,76,1],[29,78,29,112,1],[30,9,30,10,1],[34,9,34,10,1],[35,13,35,57,1],[36,13,36,47,1],[37,9,37,10,1],[40,9,40,10,1],[41,13,41,52,1],[42,9,42,10,1],[45,9,45,10,1],[46,13,46,46,1],[47,13,47,41,1],[48,13,48,20,1],[48,22,48,41,1],[48,42,48,44,1],[48,45,48,61,1],[49,13,49,20,1],[49,22,49,32,1],[49,33,49,35,1],[49,36,49,40,1],[50,13,50,14,1],[51,17,51,62,1],[52,17,52,50,1],[53,17,53,38,1],[53,38,53,71,1],[53,71,53,73,1],[53,17,53,73,1],[54,21,54,30,1],[55,17,55,39,1],[56,17,56,30,1],[57,17,57,92,1],[58,17,58,18,1],[59,21,59,59,1],[60,21,60,44,1],[60,45,60,62,1],[61,17,61,18,1],[63,17,64,43,1],[64,43,64,66,1],[64,66,64,80,1],[64,80,64,100,1],[64,100,64,102,1],[63,17,64,102,1],[65,17,65,67,1],[65,67,65,78,1],[65,78,65,80,1],[65,17,65,80,1],[66,17,66,71,1],[66,72,66,94,1],[67,13,67,14,1],[69,13,69,28,1],[70,9,70,10,1],[72,69,72,93,1],[73,83,73,116,1],[74,69,74,91,1]]);
    </script>
  </body>
</html>