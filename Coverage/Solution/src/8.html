<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\arg-parser\ArgParser\ArgParser.Core\DefaultParseStrategy.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using ArgParser.Core.Validation;

namespace ArgParser.Core
{
    public class DefaultParseStrategy&lt;T&gt; : DefaultParseStrategy, IParseStrategy&lt;T&gt;
    {
            
        // ReSharper disable once SuspiciousTypeConversion.Global
        public DefaultParseStrategy(IEnumerable&lt;Func&lt;T&gt;&gt; factoryFuncs = null) : base(factoryFuncs?.Cast&lt;Func&lt;object&gt;&gt;())
        {
        }

            
        public IParseResult Parse(IEnumerable&lt;IParser&lt;T&gt;&gt; parsers, string[] args) =&gt; base.Parse(parsers, args);
    }

    public class DefaultParseStrategy : IParseStrategy
    {
            
        public DefaultParseStrategy(IEnumerable&lt;Func&lt;object&gt;&gt; factoryFuncs = null)
        {
            foreach (var factoryFunc in factoryFuncs ?? new Func&lt;object&gt;[0]) FactoryFunctions.Add(factoryFunc);
        }

            
        public virtual IParseResult Parse(IEnumerable&lt;IParser&gt; parsers, string[] args)
        {
            var results = ParseInstances(parsers, args);
            return CreateParseResult(results);
        }

        protected virtual IParseResult CreateParseResult(List&lt;object&gt; results) =&gt; new DefaultParseResult(results);

        protected virtual List&lt;object&gt; ParseInstances(IEnumerable&lt;IParser&gt; parsers, string[] args)
        {
            var results = new List&lt;object&gt;();
            var list = parsers.ToList();
            foreach (var factoryFunction in FactoryFunctions)
            foreach (var parser in list)
            {
                parser.Reset();
                var info = IterationInfoFactory.Create(args);
                var instance = factoryFunction();
                if (results.Any(r =&gt; r.GetType() == instance.GetType()))
                    continue;
                var hasFailed = false;
                var last = 0;
                while (!hasFailed &amp;&amp; !info.IsComplete &amp;&amp; parser.CanConsume(instance, info))
                {
                    info = parser.Consume(instance, info);
                    if (info.Index &lt;= last) hasFailed = true;
                }

                var validationResults =
                    Validators.Where(v =&gt; v.CanValidate(instance)).Select(v =&gt; v.Validate(instance));
                var passedValidation = validationResults.All(r =&gt; r.IsSuccess);
                if (!hasFailed &amp;&amp; info.IsComplete &amp;&amp; passedValidation) results.Add(instance);
            }

            return results;
        }

        public IList&lt;Func&lt;object&gt;&gt; FactoryFunctions { get; set; } = new List&lt;Func&lt;object&gt;&gt;();
        public virtual IIterationInfoFactory IterationInfoFactory { get; set; } = new DefaultIterationInfoFactory();
        public virtual IList&lt;IValidator&gt; Validators { get; set; } = new List&lt;IValidator&gt;();
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[12,81,12,121,1],[13,9,13,10,1],[14,9,14,10,1],[17,86,17,111,1],[23,9,23,83,1],[24,9,24,10,1],[25,13,25,20,1],[25,22,25,37,1],[25,38,25,40,1],[25,41,25,76,1],[25,78,25,112,1],[26,9,26,10,1],[30,9,30,10,1],[31,13,31,57,1],[32,13,32,47,1],[33,9,33,10,1],[35,83,35,114,1],[38,9,38,10,1],[39,13,39,46,1],[40,13,40,41,1],[41,13,41,20,1],[41,22,41,41,1],[41,42,41,44,1],[41,45,41,61,1],[42,13,42,20,1],[42,22,42,32,1],[42,33,42,35,1],[42,36,42,40,1],[43,13,43,14,1],[44,17,44,32,1],[45,17,45,62,1],[46,17,46,50,1],[47,17,47,38,1],[47,38,47,71,1],[47,71,47,73,1],[47,17,47,73,1],[48,21,48,30,1],[49,17,49,39,1],[50,17,50,30,1],[51,17,51,92,1],[52,17,52,18,1],[53,21,53,59,1],[54,21,54,44,1],[54,45,54,62,1],[55,17,55,18,1],[57,17,58,43,1],[58,43,58,66,1],[58,66,58,80,1],[58,80,58,100,1],[58,100,58,102,1],[57,17,58,102,1],[59,17,59,67,1],[59,67,59,78,1],[59,78,59,80,1],[59,17,59,80,1],[60,17,60,71,1],[60,72,60,94,1],[61,13,61,14,1],[63,13,63,28,1],[64,9,64,10,1],[66,69,66,93,1],[67,83,67,116,1],[68,69,68,91,1]]);
    </script>
  </body>
</html>