<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\arg-parser\ArgParser\ArgParser.Styles\ParseStrategy\ParseStrategy.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Collections.Generic;
using System.Linq;
using ArgParser.Core;

namespace ArgParser.Styles.ParseStrategy
{
    public class ParseStrategy : IParseStrategy
    {
        public ParseStrategy(IContext context, string rootParserId)
        {
            Context = context.ThrowIfArgumentNull(nameof(context));
            RootParserId = rootParserId.ThrowIfArgumentNull(nameof(rootParserId));
            SetContext(context);
        }

        private IContext _context;

        public virtual IParseResult Parse(string[] args, IContext context)
        {
            ChainIdentificationResult chainRes = null;
            try
            {
                chainRes = ChainIdentificationStrategy.Identify(new ChainIdentificationRequest(args, context));
                var mutatedArgs = ArgsMutator.Mutate(new MutateArgsRequest(args, chainRes.Chain, context));
                var info = IterationInfoFactory.Create(new IterationInfoRequest(chainRes, mutatedArgs, args));
                if (chainRes.IdentifiedParser.FactoryFunction == null)
                    throw new NoFactoryFunctionException(
                        $&quot;No factory function set on parser={chainRes.IdentifiedParser.Id}&quot;);
                var instance = chainRes.IdentifiedParser.FactoryFunction();
                while (!info.IsComplete())
                {
                    var potentialConsumerResult = PotentialConsumerStrategy.IdentifyPotentialConsumer(
                        new PotentialConsumerRequest(chainRes, info, instance));
                    if (!potentialConsumerResult.Success)
                        throw new UnexpectedArgException($&quot;Encountered unexpected argument={info.Current}&quot;);
                    var selected = ConsumerSelectionStrategy.Select(potentialConsumerResult);
                    var consumptionRequest = ConsumptionRequestFactory.Create(potentialConsumerResult, selected);
                    var consumptionResult = selected.ConsumingParameter.Consume(instance, consumptionRequest);
                    if (consumptionResult.ParseExceptions.Any())
                        return new ParseResult(new Dictionary&lt;object, Parser&gt;(), consumptionResult.ParseExceptions);
                    info = consumptionResult.Info;
                }

                return ParseResultFactory.Create(new Dictionary&lt;object, Parser&gt;
                {
                    [instance] = chainRes.IdentifiedParser
                }, null);
            }
            catch (ParseException e)
            {
                return new ParseResult(null, e.ToEnumerableOfOne());
            }
            finally
            {
                chainRes?.Chain.ToList().ForEach(p =&gt; p.Reset());
            }
        }

        private void SetContext(IContext context)
        {
            _context = context;
            if (ArgsMutator == null)
                ArgsMutator = new ArgsMutator(context);
            if (ChainIdentificationStrategy == null)
                ChainIdentificationStrategy = new ParserChainIdentificationStrategy(context);
            if (ConsumerSelectionStrategy == null)
                ConsumerSelectionStrategy = new ConsumerSelectionStrategy(context);
            if (ConsumptionRequestFactory == null)
                ConsumptionRequestFactory = new ConsumptionRequestFactory(context);
            if (IterationInfoFactory == null)
                IterationInfoFactory = new IterationInfoFactory(context);
            if (ParseResultFactory == null)
                ParseResultFactory = new ParseResultFactory(context);
            if (PotentialConsumerStrategy == null)
                PotentialConsumerStrategy = new PotentialConsumerStrategy(context);
            ArgsMutator.Context = context;
            ChainIdentificationStrategy.Context = context;
            ConsumerSelectionStrategy.Context = context;
            ConsumptionRequestFactory.Context = context;
            IterationInfoFactory.Context = context;
            ParseResultFactory.Context = context;
            PotentialConsumerStrategy.Context = context;
        }

        public IArgsMutator ArgsMutator { get; set; }
        public IParserChainIdentificationStrategy ChainIdentificationStrategy { get; set; }
        public IConsumerSelectionStrategy ConsumerSelectionStrategy { get; set; }
        public IConsumptionRequestFactory ConsumptionRequestFactory { get; set; }

        public IContext Context
        {
            get =&gt; _context;
            set =&gt; SetContext(value);
        }

        public IIterationInfoFactory IterationInfoFactory { get; set; }
        public IParseResultFactory ParseResultFactory { get; set; }
        public IPotentialConsumerStrategy PotentialConsumerStrategy { get; set; }
        public string RootParserId { get; protected internal set; }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[9,9,9,68,1],[10,9,10,10,1],[11,13,11,68,1],[12,13,12,83,1],[13,13,13,33,1],[14,9,14,10,1],[19,9,19,10,1],[20,13,20,55,1],[22,13,22,14,1],[23,17,23,112,1],[24,17,24,108,1],[25,17,25,111,1],[26,17,26,71,1],[27,21,28,94,1],[29,17,29,76,1],[30,17,30,43,1],[31,17,31,18,1],[32,21,33,81,1],[34,21,34,58,1],[35,25,35,98,1],[36,21,36,94,1],[37,21,37,114,1],[38,21,38,111,1],[39,21,39,65,1],[40,25,40,117,1],[41,21,41,51,1],[42,17,42,18,1],[44,17,47,26,1],[49,13,49,37,1],[50,13,50,14,1],[51,17,51,69,1],[54,13,54,14,1],[55,17,55,55,1],[55,55,55,64,1],[55,64,55,66,1],[55,17,55,66,1],[56,13,56,14,1],[57,9,57,10,1],[60,9,60,10,1],[61,13,61,32,1],[62,13,62,37,1],[63,17,63,56,1],[64,13,64,53,1],[65,17,65,94,1],[66,13,66,51,1],[67,17,67,84,1],[68,13,68,51,1],[69,17,69,84,1],[70,13,70,46,1],[71,17,71,74,1],[72,13,72,44,1],[73,17,73,70,1],[74,13,74,51,1],[75,17,75,84,1],[76,13,76,43,1],[77,13,77,59,1],[78,13,78,57,1],[79,13,79,57,1],[80,13,80,52,1],[81,13,81,50,1],[82,13,82,57,1],[83,9,83,10,1],[92,20,92,28,1],[93,20,93,37,1]]);
    </script>
  </body>
</html>